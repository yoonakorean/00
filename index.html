<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>æŒ‘æˆ°è³½æ’è¡Œæ¦œèˆ‡æˆç¸¾</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  body { 
    font-family: sans-serif; 
    max-width: 800px; 
    margin: 30px auto; 
    text-align: center; 
    padding: 0 10px; 
  }

  #logo { 
    width: 150px; 
    max-width: 80%; 
    margin: 10px auto; 
    display: block; 
  }

  input, button { 
    padding: 10px; 
    font-size: 16px; 
    width: 80%; 
    max-width: 400px; 
    margin: 10px auto; 
    display: block; 
    text-align: center; 
  }

  table { 
    margin: 10px auto; 
    border-collapse: collapse; 
    width: 100%; 
    max-width: 780px; 
  }

  th, td { 
    border: 1px solid #ccc; 
    padding: 8px 10px; 
    text-align: center; 
    vertical-align: middle; 
  }

  th { background-color: #f2f2f2; }

  .pass .score { color: green; font-weight: normal; }
  .pass .status { color: green; font-weight: normal; }
  .pass a { color: black; text-decoration: none; font-weight: normal; }

  .not-tested { color: gray; font-style: italic; }
  .locked { color: gray; font-style: italic; }
  .locked a { pointer-events: none; cursor: default; text-decoration: none; color: gray; }

  a:hover { text-decoration: underline; }

  /* æ’è¡Œæ¦œå‰ä¸‰ååº•è‰² */
  .gold { background-color: #fff7c2; }   
  .silver { background-color: #ffffff; } 
  .bronze { background-color: #ffffff; } 

  /* ä½¿ç”¨è€…å°ˆå±¬åº•è‰² */
  .self-row { background-color: #cce5ff; }

  /* çç‰Œæ”¾å¤§ */
  td.medal { font-size: 32px; }

  /* æ‰‹æ©Ÿè‡ªé©æ‡‰ */
  @media (max-width: 480px) {
    body { padding: 10px; }

    h1, h2 { font-size: 18px; }

    input, button {
      width: 100%; 
      font-size: 14px; 
      padding: 8px; 
      margin-left: auto; 
      margin-right: auto;
    }

    table, th, td { font-size: 12px; padding: 6px 4px; }

    td.medal { font-size: 24px; }

    td a, td span { display: block; word-break: break-word; }
  }
</style>
</head>
<body>
<img src="logo.png" alt="Logo" id="logo" />
<h1>æ­¡è¿åƒåŠ æŒ‘æˆ°è³½</h1>
<input id="nicknameInput" type="text" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" />
<button onclick="queryScores()">æŸ¥è©¢æˆç¸¾</button>

<div id="leaderboard"></div>
<div id="result"></div>

<script>
const listeningUnits = ["0-1 å–®å­—è½åŠ›æŒ‘æˆ°","0-2 å–®å­—è½åŠ›æŒ‘æˆ°","0-3 å–®å­—è½åŠ›æŒ‘æˆ°","0-4 å–®å­—è½åŠ›æŒ‘æˆ°","0-5 å–®å­—è½åŠ›æŒ‘æˆ°","0-6 å–®å­—è½åŠ›æŒ‘æˆ°","0-7 å–®å­—è½åŠ›æŒ‘æˆ°","0-8 å–®å­—è½åŠ›æŒ‘æˆ°","0-9 å–®å­—è½åŠ›æŒ‘æˆ°","0-10 å–®å­—è½åŠ›æŒ‘æˆ°","0-11 å–®å­—è½åŠ›æŒ‘æˆ°"];
const dictationUnits = ["0-1 å–®å­—è½æ‰“æŒ‘æˆ°","0-2 å–®å­—è½æ‰“æŒ‘æˆ°","0-3 å–®å­—è½æ‰“æŒ‘æˆ°","0-4 å–®å­—è½æ‰“æŒ‘æˆ°","0-5 å–®å­—è½æ‰“æŒ‘æˆ°","0-6 å–®å­—è½æ‰“æŒ‘æˆ°","0-7 å–®å­—è½æ‰“æŒ‘æˆ°","0-8 å–®å­—è½æ‰“æŒ‘æˆ°","0-9 å–®å­—è½æ‰“æŒ‘æˆ°","0-10 å–®å­—è½æ‰“æŒ‘æˆ°","0-11 å–®å­—è½æ‰“æŒ‘æˆ°"];
const meaningUnits = ["", "0-2 å–®å­—è½éŸ³è¾¨ç¾©æŒ‘æˆ°","0-3 å–®å­—è½éŸ³è¾¨ç¾©æŒ‘æˆ°","0-4 å–®å­—è½éŸ³è¾¨ç¾©æŒ‘æˆ°","0-5 å–®å­—è½éŸ³è¾¨ç¾©æŒ‘æˆ°","0-6 å–®å­—è½éŸ³è¾¨ç¾©æŒ‘æˆ°","0-7 å–®å­—è½éŸ³è¾¨ç¾©æŒ‘æˆ°","0-8 å–®å­—è½éŸ³è¾¨ç¾©æŒ‘æˆ°","0-9 å–®å­—è½éŸ³è¾¨ç¾©æŒ‘æˆ°","0-10 å–®å­—è½éŸ³è¾¨ç¾©æŒ‘æˆ°","0-11 å–®å­—è½éŸ³è¾¨ç¾©æŒ‘æˆ°"];
const unitLinks = {
  "0-1 å–®å­—è½éŸ³è¾¨ç¾©æŒ‘æˆ°": "",
  "0-1 å–®å­—è½åŠ›æŒ‘æˆ°": "https://yoonakorean.github.io/0001WC/",
  "0-1 å–®å­—è½æ‰“æŒ‘æˆ°": "https://yoonakorean.github.io/0001WT/",
  "0-2 å–®å­—è½éŸ³è¾¨ç¾©æŒ‘æˆ°": "https://yoonakorean.github.io/0002WM/",
  "0-2 å–®å­—è½åŠ›æŒ‘æˆ°": "https://yoonakorean.github.io/0002WC/",
  "0-2 å–®å­—è½æ‰“æŒ‘æˆ°": "https://yoonakorean.github.io/0002WT/",
  "0-3 å–®å­—è½éŸ³è¾¨ç¾©æŒ‘æˆ°": "https://yoonakorean.github.io/0003WM/",
  "0-3 å–®å­—è½åŠ›æŒ‘æˆ°": "https://yoonakorean.github.io/0003WC/",
  "0-3 å–®å­—è½æ‰“æŒ‘æˆ°": "https://yoonakorean.github.io/0003WT/",
  "0-4 å–®å­—è½éŸ³è¾¨ç¾©æŒ‘æˆ°": "https://yoonakorean.github.io/0004WM/",
  "0-4 å–®å­—è½åŠ›æŒ‘æˆ°": "https://yoonakorean.github.io/0004WC/",
  "0-4 å–®å­—è½æ‰“æŒ‘æˆ°": "https://yoonakorean.github.io/0004WT/",
  "0-5 å–®å­—è½éŸ³è¾¨ç¾©æŒ‘æˆ°": "https://yoonakorean.github.io/0005WM/",
  "0-5 å–®å­—è½åŠ›æŒ‘æˆ°": "https://yoonakorean.github.io/0005WC/",
  "0-5 å–®å­—è½æ‰“æŒ‘æˆ°": "https://yoonakorean.github.io/0005WT/",
  "0-6 å–®å­—è½éŸ³è¾¨ç¾©æŒ‘æˆ°": "https://yoonakorean.github.io/0006WM/",
  "0-6 å–®å­—è½åŠ›æŒ‘æˆ°": "https://yoonakorean.github.io/0006WC/",
  "0-6 å–®å­—è½æ‰“æŒ‘æˆ°": "https://yoonakorean.github.io/0006WT/",
  "0-7 å–®å­—è½éŸ³è¾¨ç¾©æŒ‘æˆ°": "https://yoonakorean.github.io/0007WM/",
  "0-7 å–®å­—è½åŠ›æŒ‘æˆ°": "https://yoonakorean.github.io/0007WC/",
  "0-7 å–®å­—è½æ‰“æŒ‘æˆ°": "https://yoonakorean.github.io/0007WT/",
  "0-8 å–®å­—è½éŸ³è¾¨ç¾©æŒ‘æˆ°": "https://yoonakorean.github.io/0008WM/",
  "0-8 å–®å­—è½åŠ›æŒ‘æˆ°": "https://yoonakorean.github.io/0008WC/",
  "0-8 å–®å­—è½æ‰“æŒ‘æˆ°": "https://yoonakorean.github.io/0008WT/",
  "0-9 å–®å­—è½éŸ³è¾¨ç¾©æŒ‘æˆ°": "https://yoonakorean.github.io/0009WM/",
  "0-9 å–®å­—è½åŠ›æŒ‘æˆ°": "https://yoonakorean.github.io/0009WC/",
  "0-9 å–®å­—è½æ‰“æŒ‘æˆ°": "https://yoonakorean.github.io/0009WT/",
  "0-10 å–®å­—è½éŸ³è¾¨ç¾©æŒ‘æˆ°": "https://yoonakorean.github.io/0010WM/",
  "0-10 å–®å­—è½åŠ›æŒ‘æˆ°": "https://yoonakorean.github.io/0010WC/",
  "0-10 å–®å­—è½æ‰“æŒ‘æˆ°": "https://yoonakorean.github.io/0010WT/",
  "0-11 å–®å­—è½éŸ³è¾¨ç¾©æŒ‘æˆ°": "https://yoonakorean.github.io/0011WM/",
  "0-11 å–®å­—è½åŠ›æŒ‘æˆ°": "https://yoonakorean.github.io/0011WC/",
  "0-11 å–®å­—è½æ‰“æŒ‘æˆ°": "https://yoonakorean.github.io/0011WT/"
};

const allUnitsGrouped = [];
for(let i=0;i<listeningUnits.length;i++) allUnitsGrouped.push([meaningUnits[i],listeningUnits[i],dictationUnits[i]]);

function getUnitLink(unitName){ return unitLinks[unitName] || "#"; }
function parseTime(timeStr){ 
  if(!timeStr) return 0; 
  const match = timeStr.match(/(\d+)/);
  return match?Number(match[1]):0;
}
function formatTime(seconds){
  const m = Math.floor(seconds/60);
  const s = seconds % 60;
  return `${m}:${s.toString().padStart(2,'0')}`;
}

// æ¸²æŸ“å–®å…ƒè¡¨
function renderUnitTable(userData=null){
  let html=`<table><thead><tr><th>å–®å­—è½éŸ³è¾¨ç¾©æŒ‘æˆ°</th><th>å–®å­—è½åŠ›æŒ‘æˆ°</th><th>å–®å­—è½æ‰“æŒ‘æˆ°</th></tr></thead><tbody>`;
  let unlockNext = true;
  allUnitsGrouped.forEach(row=>{
    html+="<tr>";
    row.forEach(unitName=>{
      if(!unitName.trim()){ html+="<td></td>"; return; }
      const score=userData?.units[unitName]?.score || 0;
      const pass=score>=80;
      if(unlockNext){
        html+=`<td class="${pass?'pass':'not-tested'}"><a href="${getUnitLink(unitName)}" target="_blank">${unitName}</a><br>`;
        html+=pass?`<span class="score">${score} åˆ†</span> <span class="status">âœ…åˆæ ¼</span>`:"å°šæœªæŒ‘æˆ°";
        html+="</td>";
        unlockNext=pass;
      }else{
        html+=`<td class="locked">${unitName}<br>ğŸ”’ é–å®š</td>`;
      }
    });
    html+="</tr>";
  });
  html+="</tbody></table>";
  document.getElementById("result").innerHTML=html;
}

// åå­—å±€éƒ¨éš±è—
function maskName(name){
  if(!name) return "";
  if(name.length < 2) return name;
  return name[0] + "O" + name.slice(2);
}

// ç”¢ç”Ÿæ’è¡Œæ¦œ (å¯å¸¶å…¥ä½¿ç”¨è€…)
function renderLeaderboard(leaderboard, userData=null, userIndex=-1){
  let html=`<h2>æ’è¡Œæ¦œå‰ä¸‰å</h2><table><thead><tr><th>åæ¬¡</th><th>å§“å</th><th>é€šé—œæ•¸</th><th>ç¸½åˆ†</th><th>å¹³å‡æ™‚é–“</th></tr></thead><tbody>`;
  const medals=["ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰"];
  const medalClasses=["gold","silver","bronze"];

  leaderboard.slice(0,3).forEach((u,i)=>{
    const displayName = userData && u.name === userData.name ? u.name : maskName(u.name);
    html+=`<tr class="${medalClasses[i]}"><td class="medal">${medals[i]}</td><td>${displayName}</td><td>${u.passCount}</td><td>${u.totalScore}</td><td>${formatTime(Math.round(u.avgTime))}</td></tr>`;
  });

  // ç¬¬ 4 æ ¼é¡¯ç¤ºä½¿ç”¨è€…çš„å¯¦éš›æ’åæ•¸å­—ï¼Œåå­—å®Œæ•´
  if(userData){
    html+=`<tr class="self-row"><td class="medal">${userIndex+1}</td><td>${userData.name}</td><td>${userData.passCount}</td><td>${userData.totalScore}</td><td>${formatTime(Math.round(userData.avgTime))}</td></tr>`;
  }else{
    html+=`<tr class="self-row"><td colspan="5">ï¼ˆæ­¤è™•é¡¯ç¤ºæŸ¥è©¢ä½¿ç”¨è€…æˆç¸¾ï¼‰</td></tr>`;
  }

  html+=`</tbody></table>`;
  document.getElementById("leaderboard").innerHTML=html;
}

// è®€å– API & æ’è¡Œæ¦œ
async function loadLeaderboard(nickname=""){
  const resultDiv=document.getElementById("result");

  try{
    const apiUrl="https://api.sheetbest.com/sheets/6609511a-f588-4e4f-bd2b-ed551cab8770";
    const res = await fetch(apiUrl);
    const data = await res.json();

    const unitPattern = /^0-(1[0-1]|[1-9])/; 
    const userBest={};
    data.forEach(r=>{
      if(!r.nickname) return;
      const unit=(r.gametitle||"").trim();
      if(!unitPattern.test(unit)) return;
      let score=Number(r.score);
      let time=parseTime(r.time);
      if(isNaN(score)) score=0;
      if(!userBest[r.nickname]) userBest[r.nickname]={};
      if(!userBest[r.nickname][unit] || score>userBest[r.nickname][unit].score){
        userBest[r.nickname][unit]={score,time};
      }
    });

    const leaderboard=Object.entries(userBest).map(([name,units])=>{
      const passed=Object.values(units).filter(u=>u.score>=80);
      const passCount=passed.length;
      const totalScore=passed.reduce((a,b)=>a+b.score,0);
      const totalTime=Object.values(units).reduce((a,b)=>a+b.time,0);
      const challengeCount=Object.keys(units).length;
      const avgTime=challengeCount?totalTime/challengeCount:0;
      return {name,passCount,totalScore,avgTime,units};
    });

    leaderboard.sort((a,b)=>{
      if(b.passCount!==a.passCount) return b.passCount-a.passCount;
      if(b.totalScore!==a.totalScore) return b.totalScore-a.totalScore;
      return a.avgTime-b.avgTime;
    });

    let userData=null, userIndex=-1;
    if(nickname){
      userIndex=leaderboard.findIndex(u=>u.name.toLowerCase()===nickname.toLowerCase());
      userData=userIndex>=0?leaderboard[userIndex]:null;
    }

    renderLeaderboard(leaderboard,userData,userIndex);

    if(userData){
      renderUnitTable(userData);
    }else{
      renderUnitTable();
    }

  }catch(err){
    console.error(err);
    resultDiv.innerHTML=`<p style="color:red;">ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>`;
  }
}

// æŸ¥è©¢ä½¿ç”¨è€…
function queryScores(){
  const nickname=document.getElementById("nicknameInput").value.trim();
  if(nickname) loadLeaderboard(nickname);
}

// é é¢ä¸€é–‹å•Ÿè‡ªå‹•è¼‰å…¥æ’è¡Œæ¦œ
window.onload=()=>loadLeaderboard();
</script>
</body>
</html>
